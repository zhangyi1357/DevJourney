# AimRT 生成代码版本检查

## Protobuf 的做法

参考 [protobuf 跨版本运行时保证](https://protobuf.dev/support/cross-version-runtime-guarantee/)

简单总结：

- 新的生成代码 + 旧的运行时 = 不允许
- 旧的生成代码 + 新的运行时 = 仅支持一小段时间

体现在代码里：

```cpp
#if PROTOBUF_VERSION < 3021000
#error This file was generated by a newer version of protoc which is
#error incompatible with your Protocol Buffer headers. Please update
#error your headers.
#endif
#if 3021012 < PROTOBUF_MIN_PROTOC_VERSION
#error This file was generated by an older version of protoc which is
#error incompatible with your Protocol Buffer headers. Please
#error regenerate this file with a newer version of protoc.
#endif
```

其中 302100 和 3021012 是生成的时候硬编码进去的内容，PROTOBUF_VERSION 和 PROTOBUF_MIN_PROTOC_VERSION 是构建时的值，分别表示当前 PROTOBUF 运行时版本和当前 PROTOBUF 运行时所能接受的最小 protoc 生成代码版本，不满足条件的情况下编译直接报错。

## 初步方案

AimRT 中版本检查方案初步构想：

1. 只使用一个值，AIMRT_GENCODE_VERSION，这个值与 AimRT 本身的版本号无关，只有**生成代码部分产生变化**或者**使用生成代码的接口部分产生变化**，这个值才会变化

      1. 生成代码部分包括各个代码生成器中的模版代码和生成逻辑
      2. 使用生成代码的部分包括 AimRT 中与 rpc 生成代码交互的部分

2. 版本号采取 x.y.z 的形式，z 版本之间互相兼容，y 版本之间向前兼容，x 版本之间不兼容

      1. 3.4.1 与 3.4.2 完全兼容，无论如何搭配都兼容
      2. 3.5.1 与 3.4.1 向前兼容，运行时 3.5.1 可以运行 3.4.1 生成的代码，而运行时 3.4.1 不能运行 3.5.1 生成的代码
      3. 4.5.1 与 3.5.1 不兼容，无论如何搭配运行时和生成时代码版本都不能运行


3. cpp 和 py 中各搞一套这个版本，互相独立

      1. cpp 中不兼容则编译报错，如果不完全匹配则报编译警告
      2. py 中不兼容直接运行时报错


